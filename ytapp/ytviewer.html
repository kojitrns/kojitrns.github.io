<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <link rel="stylesheet" type="text/css" href="css/box.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
    <script src="https://unpkg.com/react@15/dist/react.min.js"></script>
    <script src="https://unpkg.com/react-dom@15/dist/react-dom.min.js"></script>
    <script src="https://fb.me/JSXTransformer-0.13.3.js"></script>
  </head>
  
  <body style="background-color : #BDBDBD">
    <h1>simple ytviewer</h1>
    <center>
      <p>
        <div id="player"></div>
      </p>
    </center>

    <div id="app"></div>

    <script type="text/jsx">
      var tag = document.createElement('script');
      tag.src = "https://www.youtube.com/iframe_api";
      var firstScriptTag = document.getElementsByTagName('script')[0];
      firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
      var list,next_page ;
      var playerFLG=0, play_id =0, got=[], search_word;
       
      function playVideo2(id) {
        current_num = id;
        $('body, html').scrollTop(0);
        if(playerFLG<1) {
          playerFLG++;
          ytPlayer = new YT.Player(
            'player',
            {
              width: 740,
              height: 500,
              videoId: list[current_num]['id']['videoId'],
              events: {
                'onReady': onPlayerReady,
                'onStateChange': onPlayerStateChange
              }
            }
          );
        }
        else {
          ytPlayer.loadVideoById(list[current_num]['id']['videoId'],0);
        }

        function onPlayerStateChange(event){
          if(event.data == YT.PlayerState.ENDED){
            var time = 0;
            if( ++current_num == list.length ){ 
              if(list["nextPageToken"]) {
                time = 2000;
              }
              current_num = 0;
            }
            setTimeout(function() {
              ytPlayer.loadVideoById(list[current_num]['id']['videoId'],0);
            }, time);
          }
        }

        function onPlayerReady(event) {
            event.target.playVideo();
        }
      }

      var Parent = React.createClass({
        getInitialState: function () {
          return {
            list: [],
            word: "",
              hst_flag: false,
              hst_list: [],
              detail_list: []
          };
        },

        componentDidMount: function () {
          window.addEventListener('scroll', this.onScroll);
        },

        onScroll: function(detail) {
            var scrollHeight = $(document).height();
            var scrollPosition = $(window).height() + $(window).scrollTop();
            if ((scrollHeight - scrollPosition) / scrollHeight < 0.1) {
              this.api_call_search();
            }
        },

        get_detail: function(){
          const self = this;
          var dt_list = self.state.detail_list;           
          channel = event.srcElement.className;
          var param = {"key":"AIzaSyD3R2gavNlItHEZWTt-_UOMEwFwMN5reiQ",
            "part":"statistics,snippet,contentDetails",
            "id":channel
          };

          $.getJSON(
            "https://www.googleapis.com/youtube/v3/channels?",
            param,
            function(data, status) {
              var title  =data["items"][0]["snippet"]["title"],
              uploads=data["items"][0]["contentDetails"]["relatedPlaylists"]["uploads"];
              dt_list[channel] = {"uploads" : uploads, "video_num": data["items"][0]["statistics"]["videoCount"]};
              self.setState({detail_list : dt_list});
            }
          );
        },

        api_call_search: function(){
          const self = this;
          var param = {"key":"AIzaSyD3R2gavNlItHEZWTt-_UOMEwFwMN5reiQ",
            "part":"snippet",
            "maxResults":50,
            "order":"date",
            "type":"video",
            "videoDefinition":"any",
            "q": search_word
          }; 
          if(got.includes(next_page))return;
          if(next_page){param["pageToken"] = next_page; got.push(next_page);}
          $.getJSON(
          "https://www.googleapis.com/youtube/v3/search?",
           param,
            function(data, status) { 
              list = list ? list.concat(data["items"]):data["items"];
              next_page = data["nextPageToken"]?data["nextPageToken"]:null;
              self.setState({list:list});
            }
          );
        },

        playVideo : function(event){
          play_id=event.target.id;
          playVideo2(play_id);
        },
         
        on_click: function(){
          this.setState({list:list});
        },

        onHistory : function() {
          list=null; got=[]; next_page=null;
          search_word=event.srcElement.className;
          this.api_call_search();
        },

        render: function() {
          var on_search = (event) =>{
            this.setState({word:event.target.value});
          },
          handleKeyPress = (event) => {
            if(event.key == 'Enter'){
              this.setState({detail_list : []}); 
              list=null; got=[],next_page=null;
              search_word=event.target.value;
              this.setState(prevState => ({ hst_list: prevState.hst_list.concat([search_word])}));
              this.api_call_search();
            }
          };
          MouseOver = (event) => {
            this.setState({hst_flag : true});
          };
          MouseOut = (event) => {
            this.setState({hst_flag : false});
          };
          const self = this;
          const dt_list = this.state.detail_list;
          const videos = this.state.list.map( function(data, index){
              const video_url="https://www.youtube.com/watch?v=";
              const dt_url = "uplist_data.html#";
              var img_url=data["snippet"]["thumbnails"]["medium"]["url"],
              title_o=data["snippet"]["title"],title_cut = title_o,
              detail = <span onClick={self.get_detail} className={data["snippet"]["channelId"]}>list</span>;

              if(title_o.length > 30) title_cut = title_o.slice(0,30);

              if(dt_list[data["snippet"]["channelId"]])
                detail = <a href={dt_url+dt_list[data["snippet"]["channelId"]].uploads} target={"_blank"}>
                {dt_list[data["snippet"]["channelId"]].video_num+" videos"}</a>;
              
              return (
                <div className={"imagebox2"}>
                <a href={video_url+data['id']['videoId']} target={"_blank"} title={title_o}>
                <p className={"image2"}><img src={img_url} alt="video_thumb"  width={200} height={150} /></p>
                <p className={"caption2"}>{title_cut}</p></a>{detail}
                <span className="play" id={index} onClick={self.playVideo}> play</span>
                </div>
              );
          });
            
          const hst_data = this.state.hst_list.map(function(data, index){ 
            return <span className={data} onClick={self.onHistory}>{data+" "}</span>;
          }); 
          const hst = this.state.hst_flag ?  <div className={"history"}>{hst_data}</div> : <div>&nbsp;search hst</div>;

          return <div><p><input type="text" onChange={on_search} value={this.state.word} onKeyPress={handleKeyPress} />
          <div onMouseEnter={MouseOver} onMouseLeave={MouseOut} style={{display : 'inline-block'}}> {hst}</div></p>{videos}</div>;
        }
      });

      var m = ReactDOM.render(<Parent />, document.getElementById('app'));
    </script>
  </body>
</html>